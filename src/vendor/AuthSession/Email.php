<?php


/**
 * Author: Amir Hossein Jahani | iAmir.net
 * Last modified: 9/16/20, 12:35 PM
 * Copyright (c) 2020. Powered by iamir.net
 */

namespace iLaravel\iAuth\Vendor\AuthSession;

use iLaravel\Core\iApp\Http\Requests\iLaravel as Request;
use Illuminate\Auth\AuthenticationException;
use Carbon\Carbon;

class Email extends Session
{
    public $method = 'email';
    public $authCheck = true;

    public function store(Request $request, $user = null, $email = null)
    {
        $email = $email ? :  $this->emailModel::findByEmail($request->input('email'), null, 'User');
        if ($email)
            throw new AuthenticationException('Email has already been verified or registered for another user.');
        $user = $user ? : auth()->user();
        if ($user->email->verified_at && (!$user->expired_at_change_email || $user->expired_at_change_email < Carbon::now()->timestamp))
            throw new AuthenticationException('Email change session not found.');
        return parent::store($request, $user); // TODO: Change the autogenerated stub
    }

    public function verify(Request $request, $session, $token, $pin)
    {
        return $this->vendor::verify($request, $session, $token, $pin, iresource('User'), function ($request, $result, $session, $bridge) {
            $user = $session->item();
            $user->expired_at_change_email = null;
            $user->save();
            list($name, $domain) = explode('@', $session->value);
            $email = $session->item()->email()->first();
            $email->name  = $name;
            $email->domain  = $domain;
            $email->verified_at  = Carbon::now();
            $email->save();
            return [$result, null];
        });
    }

    public function rules(Request $request, $action) {
        switch ($action) {
            case 'store':
                return [
                    'email' => "required|max:191|regex:/^[a-zA-Z0-9._-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/",
                ];
                break;
        }
    }
}
